name: TeamCity CI

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  statuses: write
  checks: write

jobs:
  trigger-teamcity:
    name: Trigger TeamCity Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [windows, linux]
        include:
          - platform: windows
            build_type: ${{ vars.TEAMCITY_BUILD_TYPE_WINDOWS }}
          - platform: linux
            build_type: ${{ vars.TEAMCITY_BUILD_TYPE_LINUX }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BRANCH_NAME=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
            echo "GIT_BRANCH=refs/heads/${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          else
            echo "GIT_BRANCH=${GITHUB_REF}" >> $GITHUB_ENV
            echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
          fi
          echo "Branch: $BRANCH_NAME (ref: $GIT_BRANCH)"

      - name: Trigger TeamCity Build
        id: teamcity
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          TEAMCITY_BUILD_TYPE: ${{ matrix.build_type }}
          GIT_BRANCH: ${{ env.GIT_BRANCH }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          set -e
          echo "Triggering TeamCity ${{ matrix.platform }} build: $TEAMCITY_BUILD_TYPE"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $TEAMCITY_TOKEN" \
            -H "Content-Type: application/xml" \
            -H "Accept: application/json" \
            --data "<build>
              <buildType id=\"$TEAMCITY_BUILD_TYPE\"/>
              <branchName>$GIT_BRANCH</branchName>
              <properties>
                <property name=\"env.GIT_BRANCH\" value=\"$GIT_BRANCH\"/>
                <property name=\"env.GIT_COMMIT\" value=\"$GITHUB_SHA\"/>
              </properties>
            </build>" \
            "$TEAMCITY_URL/app/rest/buildQueue")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "❌ Failed to trigger build"
            echo "$BODY"
            exit 1
          fi

          BUILD_ID=$(echo "$BODY" | jq -r '.id')
          echo "Build ID=$BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Wait for TeamCity Build
        if: steps.teamcity.outputs.build_id
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          BUILD_ID: ${{ steps.teamcity.outputs.build_id }}
        run: |
          set -e
          echo "Waiting for TeamCity build $BUILD_ID..."

          while true; do
            RESPONSE=$(curl -s \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: application/json" \
              "$TEAMCITY_URL/app/rest/builds/id:$BUILD_ID?fields=state,status,webUrl")

            STATE=$(echo "$RESPONSE" | jq -r '.state')
            STATUS=$(echo "$RESPONSE" | jq -r '.status')

            echo "State=$STATE Status=$STATUS"

            if [ "$STATE" = "finished" ]; then
              if [ "$STATUS" = "SUCCESS" ]; then
                echo "✅ Build SUCCESS"
                exit 0
              else
                echo "❌ Build FAILED"
                exit 1
              fi
            fi

            sleep 30
          done
