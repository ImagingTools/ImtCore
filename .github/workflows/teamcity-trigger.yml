name: TeamCity CI

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  statuses: write
  checks: write

jobs:
  trigger-teamcity:
    name: Trigger TeamCity Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [windows, linux]
        include:
          - platform: windows
            build_type: ${{ vars.TEAMCITY_BUILD_TYPE_WINDOWS }}
          - platform: linux
            build_type: ${{ vars.TEAMCITY_BUILD_TYPE_LINUX }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            GIT_BRANCH="refs/heads/${{ github.event.pull_request.head.ref }}"
          else
            GIT_BRANCH="${GITHUB_REF}"
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          fi

          echo "BRANCH_NAME=$BRANCH_NAME" >> "$GITHUB_ENV"
          echo "GIT_BRANCH=$GIT_BRANCH" >> "$GITHUB_ENV"

          echo "Branch: $BRANCH_NAME (ref: $GIT_BRANCH)"

      - name: Trigger TeamCity Build
        id: teamcity
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          TEAMCITY_BUILD_TYPE: ${{ matrix.build_type }}
          GIT_BRANCH: ${{ env.GIT_BRANCH }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Triggering TeamCity ${{ matrix.platform }} build: $TEAMCITY_BUILD_TYPE"
          echo "Branch (TeamCity): $GIT_BRANCH"
          echo "Commit: $GITHUB_SHA"

          XML_PAYLOAD=$(cat <<'XML'
          <build>
            <buildType id="__BUILD_TYPE__"/>
            <branchName>__GIT_BRANCH__</branchName>
            <properties>
              <property name="env.GIT_BRANCH" value="__GIT_BRANCH__"/>
              <property name="env.GIT_COMMIT" value="__GITHUB_SHA__"/>
            </properties>
          </build>
          XML
          )
          XML_PAYLOAD="${XML_PAYLOAD/__BUILD_TYPE__/$TEAMCITY_BUILD_TYPE}"
          XML_PAYLOAD="${XML_PAYLOAD/__GIT_BRANCH__/$GIT_BRANCH}"
          XML_PAYLOAD="${XML_PAYLOAD/__GITHUB_SHA__/$GITHUB_SHA}"

          BODY=$(curl --fail-with-body -sS \
            -X POST \
            -H "Authorization: Bearer $TEAMCITY_TOKEN" \
            -H "Content-Type: application/xml" \
            -H "Accept: application/json" \
            --data "$XML_PAYLOAD" \
            "$TEAMCITY_URL/app/rest/buildQueue")

          BUILD_ID=$(echo "$BODY" | jq -r '.id // empty')
          WEB_URL=$(echo "$BODY" | jq -r '.webUrl // empty')

          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
            echo "❌ Failed to parse build id from TeamCity response:"
            echo "$BODY"
            exit 1
          fi

          echo "✅ Build queued. ID=$BUILD_ID"
          if [ -n "$WEB_URL" ] && [ "$WEB_URL" != "null" ]; then
            echo "TeamCity URL: $WEB_URL"
          fi

          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Wait for TeamCity Build
        if: steps.teamcity.outputs.build_id
        timeout-minutes: 60
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          BUILD_ID: ${{ steps.teamcity.outputs.build_id }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for TeamCity build $BUILD_ID..."

          MAX_WAIT_SECONDS=3300   # 55 минут (доп. защита помимо timeout-minutes)
          SLEEP_SECONDS=15
          ELAPSED=0

          while true; do
            RESPONSE=$(curl --fail-with-body -sS \
              --retry 5 --retry-delay 2 --retry-all-errors \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: application/json" \
              "$TEAMCITY_URL/app/rest/builds/id:$BUILD_ID?fields=state,status,webUrl")

            STATE=$(echo "$RESPONSE" | jq -r '.state // empty')
            STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
            WEB_URL=$(echo "$RESPONSE" | jq -r '.webUrl // empty')

            echo "State=$STATE Status=$STATUS"
            if [ -n "$WEB_URL" ] && [ "$WEB_URL" != "null" ]; then
              echo "TeamCity URL: $WEB_URL"
            fi

            if [ "$STATE" = "finished" ]; then
              if [ "$STATUS" = "SUCCESS" ]; then
                echo "✅ Build SUCCESS"
                exit 0
              else
                echo "❌ Build FAILED (status=$STATUS)"
                exit 1
              fi
            fi

            if [ "$ELAPSED" -ge "$MAX_WAIT_SECONDS" ]; then
              echo "❌ Timed out waiting for TeamCity build $BUILD_ID after ${ELAPSED}s"
              exit 1
            fi

            sleep "$SLEEP_SECONDS"
            ELAPSED=$((ELAPSED + SLEEP_SECONDS))
          done
