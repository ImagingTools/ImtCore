name: TeamCity CI

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  statuses: write
  checks: write

jobs:
  trigger-teamcity-windows:
    name: Trigger TeamCity Build (Windows)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger TeamCity Windows Build
        id: teamcity
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          TEAMCITY_BUILD_TYPE: ${{ vars.TEAMCITY_BUILD_TYPE_WINDOWS }}
        run: |
          if [ -z "$TEAMCITY_URL" ] || [ -z "$TEAMCITY_TOKEN" ] || [ -z "$TEAMCITY_BUILD_TYPE" ]; then
            echo "Error: TeamCity configuration not found in repository variables"
            echo "Please configure the following repository variables:"
            echo "  - TEAMCITY_URL: Your TeamCity server URL (e.g., https://teamcity.example.com)"
            echo "  - TEAMCITY_TOKEN: TeamCity access token with build trigger permissions"
            echo "  - TEAMCITY_BUILD_TYPE_WINDOWS: TeamCity build configuration ID for Windows (e.g., ImtCore_Build_Windows)"
            exit 1
          fi

          # Determine the correct branch reference
          # For pull requests, use the source branch (GITHUB_HEAD_REF)
          # For push events, use GITHUB_REF
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            GIT_BRANCH="refs/heads/${{ github.event.pull_request.head.ref }}"
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            echo "Pull request detected, using branch: $GIT_BRANCH"
          else
            GIT_BRANCH="${GITHUB_REF}"
            # Extract branch name from refs/heads/main -> main
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            echo "Push event detected, using ref: $GIT_BRANCH"
          fi

          # Trigger TeamCity build
          echo "Triggering Windows build: $TEAMCITY_BUILD_TYPE"
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $TEAMCITY_TOKEN" \
            -H "Content-Type: application/xml" \
            -H "Accept: application/json" \
            --data "<build><buildType id=\"$TEAMCITY_BUILD_TYPE\"/><branchName>$GIT_BRANCH</branchName><properties><property name=\"env.GIT_BRANCH\" value=\"$GIT_BRANCH\"/><property name=\"env.GIT_COMMIT\" value=\"$GITHUB_SHA\"/></properties></build>" \
            "$TEAMCITY_URL/app/rest/buildQueue")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "TeamCity Windows build triggered successfully"
            BUILD_ID=$(echo "$BODY" | jq -r '.id // empty')
            if [ -z "$BUILD_ID" ]; then
              echo "Error: Failed to extract build ID from TeamCity response"
              echo "Response: $BODY"
              exit 1
            fi
            echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
            echo "Build ID: $BUILD_ID"

            # Verify the branch name in TeamCity matches the request
            echo "Verifying branch name in TeamCity..."

            # First, check the buildQueue to get the queued build information
            VERIFY_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: application/json" \
              "$TEAMCITY_URL/app/rest/buildQueue/id:$BUILD_ID?fields=id,branchName,properties(property(name,value))")

            VERIFY_HTTP_CODE=$(echo "$VERIFY_RESPONSE" | tail -n1)
            VERIFY_BODY=$(echo "$VERIFY_RESPONSE" | sed '$d')

            echo "Debug: HTTP Status Code: $VERIFY_HTTP_CODE"
            echo "Debug: Response from TeamCity:"
            echo "$VERIFY_BODY" | jq '.' 2>/dev/null || echo "$VERIFY_BODY"

            if [ "$VERIFY_HTTP_CODE" -eq 200 ]; then
              TEAMCITY_BRANCH=$(echo "$VERIFY_BODY" | jq -r '.branchName // empty')
              # Also check the GIT_BRANCH property we set
              TC_GIT_BRANCH=$(echo "$VERIFY_BODY" | jq -r '.properties.property[]? | select(.name == "env.GIT_BRANCH") | .value // empty' 2>/dev/null)

              echo "Requested branch: $GIT_BRANCH"
              echo "TeamCity branch name: $TEAMCITY_BRANCH"
              echo "TeamCity GIT_BRANCH property: $TC_GIT_BRANCH"

              # Verify the GIT_BRANCH property matches what we sent
              if [ -n "$TC_GIT_BRANCH" ] && [ "$TC_GIT_BRANCH" = "$GIT_BRANCH" ]; then
                echo "✓ Branch verification successful: TeamCity received the correct branch"
              elif [ -z "$TC_GIT_BRANCH" ]; then
                echo "⚠ Warning: Could not retrieve env.GIT_BRANCH property from TeamCity"
                echo "  This might indicate the property was not set or TeamCity hasn't processed it yet"
                echo "  Requested: $GIT_BRANCH"
              else
                echo "✗ Branch verification failed: Mismatch detected"
                echo "  Expected: $GIT_BRANCH"
                echo "  Got: $TC_GIT_BRANCH"
                exit 1
              fi
            else
              echo "Warning: Failed to verify branch (HTTP $VERIFY_HTTP_CODE), but build was triggered"
              echo "Response: $VERIFY_BODY"
            fi
          else
            echo "Failed to trigger TeamCity Windows build. HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Wait for TeamCity Windows Build
        if: steps.teamcity.outputs.build_id
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          BUILD_ID: ${{ steps.teamcity.outputs.build_id }}
        run: |
          echo "Waiting for TeamCity Windows build $BUILD_ID to complete..."

          MAX_WAIT=3600  # Maximum wait time in seconds (1 hour)
          ELAPSED=0
          POLL_INTERVAL=30

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: application/json" \
              "$TEAMCITY_URL/app/rest/builds/id:$BUILD_ID?fields=id,state,status,statusText,webUrl")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Failed to get build status. HTTP Status: $HTTP_CODE"
              echo "Response body: $BODY"
              exit 1
            fi

            # Extract state and status, trim leading/trailing whitespace
            STATE=$(echo "$BODY" | jq -r '.state // "unknown"' | xargs)
            STATUS=$(echo "$BODY" | jq -r '.status // "unknown"' | xargs)
            STATUS_TEXT=$(echo "$BODY" | jq -r '.statusText // ""')

            echo "Build state: $STATE, status: $STATUS"
            if [ -n "$STATUS_TEXT" ]; then
              echo "Status text: $STATUS_TEXT"
            fi

            if [ "$STATE" = "finished" ]; then
              BUILD_URL=$(echo "$BODY" | jq -r '.webUrl // "N/A"')
              echo "Build URL: $BUILD_URL"

              if [ "$STATUS" = "SUCCESS" ]; then
                echo "✅ TeamCity Windows build completed successfully!"
                exit 0
              else
                echo "❌ TeamCity Windows build failed with status: $STATUS"
                exit 1
              fi
            fi

            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          echo "⏱️ Timeout waiting for TeamCity Windows build to complete"
          exit 1

      - name: Report Windows Build Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ TeamCity Windows build integration successful"
          else
            echo "❌ TeamCity Windows build integration failed"
          fi

  trigger-teamcity-linux:
    name: Trigger TeamCity Build (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger TeamCity Linux Build
        id: teamcity
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          TEAMCITY_BUILD_TYPE: ${{ vars.TEAMCITY_BUILD_TYPE_LINUX }}
        run: |
          if [ -z "$TEAMCITY_URL" ] || [ -z "$TEAMCITY_TOKEN" ] || [ -z "$TEAMCITY_BUILD_TYPE" ]; then
            echo "Error: TeamCity configuration not found in repository variables"
            echo "Please configure the following repository variables:"
            echo "  - TEAMCITY_URL: Your TeamCity server URL (e.g., https://teamcity.example.com)"
            echo "  - TEAMCITY_TOKEN: TeamCity access token with build trigger permissions"
            echo "  - TEAMCITY_BUILD_TYPE_LINUX: TeamCity build configuration ID for Linux (e.g., ImtCore_Build_Linux)"
            exit 1
          fi

          # Determine the correct branch reference
          # For pull requests, use the source branch (GITHUB_HEAD_REF)
          # For push events, use GITHUB_REF
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            GIT_BRANCH="refs/heads/${{ github.event.pull_request.head.ref }}"
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            echo "Pull request detected, using branch: $GIT_BRANCH"
          else
            GIT_BRANCH="${GITHUB_REF}"
            # Extract branch name from refs/heads/main -> main
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            echo "Push event detected, using ref: $GIT_BRANCH"
          fi

          # Trigger TeamCity build
          echo "Triggering Linux build: $TEAMCITY_BUILD_TYPE"
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $TEAMCITY_TOKEN" \
            -H "Content-Type: application/xml" \
            -H "Accept: application/json" \
            --data "<build><buildType id=\"$TEAMCITY_BUILD_TYPE\"/><branchName>$GIT_BRANCH</branchName><properties><property name=\"env.GIT_BRANCH\" value=\"$GIT_BRANCH\"/><property name=\"env.GIT_COMMIT\" value=\"$GITHUB_SHA\"/></properties></build>" \
            "$TEAMCITY_URL/app/rest/buildQueue")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "TeamCity Linux build triggered successfully"
            BUILD_ID=$(echo "$BODY" | jq -r '.id // empty')
            if [ -z "$BUILD_ID" ]; then
              echo "Error: Failed to extract build ID from TeamCity response"
              echo "Response: $BODY"
              exit 1
            fi
            echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
            echo "Build ID: $BUILD_ID"

            # Verify the branch name in TeamCity matches the request
            echo "Verifying branch name in TeamCity..."

            # First, check the buildQueue to get the queued build information
            VERIFY_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: application/json" \
              "$TEAMCITY_URL/app/rest/buildQueue/id:$BUILD_ID?fields=id,branchName,properties(property(name,value))")

            VERIFY_HTTP_CODE=$(echo "$VERIFY_RESPONSE" | tail -n1)
            VERIFY_BODY=$(echo "$VERIFY_RESPONSE" | sed '$d')

            echo "Debug: HTTP Status Code: $VERIFY_HTTP_CODE"
            echo "Debug: Response from TeamCity:"
            echo "$VERIFY_BODY" | jq '.' 2>/dev/null || echo "$VERIFY_BODY"

            if [ "$VERIFY_HTTP_CODE" -eq 200 ]; then
              TEAMCITY_BRANCH=$(echo "$VERIFY_BODY" | jq -r '.branchName // empty')
              # Also check the GIT_BRANCH property we set
              TC_GIT_BRANCH=$(echo "$VERIFY_BODY" | jq -r '.properties.property[]? | select(.name == "env.GIT_BRANCH") | .value // empty' 2>/dev/null)

              echo "Requested branch: $GIT_BRANCH"
              echo "TeamCity branch name: $TEAMCITY_BRANCH"
              echo "TeamCity GIT_BRANCH property: $TC_GIT_BRANCH"

              # Verify the GIT_BRANCH property matches what we sent
              if [ -n "$TC_GIT_BRANCH" ] && [ "$TC_GIT_BRANCH" = "$GIT_BRANCH" ]; then
                echo "✓ Branch verification successful: TeamCity received the correct branch"
              elif [ -z "$TC_GIT_BRANCH" ]; then
                echo "⚠ Warning: Could not retrieve env.GIT_BRANCH property from TeamCity"
                echo "  This might indicate the property was not set or TeamCity hasn't processed it yet"
                echo "  Requested: $GIT_BRANCH"
              else
                echo "✗ Branch verification failed: Mismatch detected"
                echo "  Expected: $GIT_BRANCH"
                echo "  Got: $TC_GIT_BRANCH"
                exit 1
              fi
            else
              echo "Warning: Failed to verify branch (HTTP $VERIFY_HTTP_CODE), but build was triggered"
              echo "Response: $VERIFY_BODY"
            fi
          else
            echo "Failed to trigger TeamCity Linux build. HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Wait for TeamCity Linux Build
        if: steps.teamcity.outputs.build_id
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
          BUILD_ID: ${{ steps.teamcity.outputs.build_id }}
        run: |
          echo "Waiting for TeamCity Linux build $BUILD_ID to complete..."

          MAX_WAIT=3600  # Maximum wait time in seconds (1 hour)
          ELAPSED=0
          POLL_INTERVAL=30

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: application/json" \
              "$TEAMCITY_URL/app/rest/builds/id:$BUILD_ID?fields=id,state,status,statusText,webUrl")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Failed to get build status. HTTP Status: $HTTP_CODE"
              echo "Response body: $BODY"
              exit 1
            fi

            # Extract state and status, trim leading/trailing whitespace
            STATE=$(echo "$BODY" | jq -r '.state // "unknown"' | xargs)
            STATUS=$(echo "$BODY" | jq -r '.status // "unknown"' | xargs)
            STATUS_TEXT=$(echo "$BODY" | jq -r '.statusText // ""')

            echo "Build state: $STATE, status: $STATUS"
            if [ -n "$STATUS_TEXT" ]; then
              echo "Status text: $STATUS_TEXT"
            fi

            if [ "$STATE" = "finished" ]; then
              BUILD_URL=$(echo "$BODY" | jq -r '.webUrl // "N/A"')
              echo "Build URL: $BUILD_URL"

              if [ "$STATUS" = "SUCCESS" ]; then
                echo "✅ TeamCity Linux build completed successfully!"
                exit 0
              else
                echo "❌ TeamCity Linux build failed with status: $STATUS"
                exit 1
              fi
            fi

            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          echo "⏱️ Timeout waiting for TeamCity Linux build to complete"
          exit 1

      - name: Report Linux Build Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ TeamCity Linux build integration successful"
          else
            echo "❌ TeamCity Linux build integration failed"
          fi
