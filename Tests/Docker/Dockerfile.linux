# Dockerfile for ImtCore test environment (Linux)
# This container provides the base infrastructure for running tests.
# Application-specific files (GUI tests, API tests, resources, startup scripts)
# should be mounted via volume mounts when running the container.

FROM node:18-bookworm

ENV DEBIAN_FRONTEND=noninteractive

# Install base dependencies and tools
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      wget \
      ca-certificates \
      curl \
      gnupg \
      lsb-release \
      xdg-utils \
      # OpenGL/Mesa full stack
      libegl1 \
      libegl-mesa0 \
      libgl1 \
      libgl1-mesa-glx \
      libgl1-mesa-dri \
      libgles2 \
      libglvnd0 \
      libglx0 \
      libglx-mesa0 \
      libopengl0 \
      mesa-utils \
      mesa-vulkan-drivers \
      # GUI/Browser testing dependencies (for Playwright)
      fonts-liberation \
      libappindicator3-1 \
      libasound2 \
      libatk-bridge2.0-0 \
      libatk1.0-0 \
      libc6 \
      libcairo2 \
      libcups2 \
      libdbus-1-3 \
      libdrm2 \
      libexpat1 \
      libfontconfig1 \
      libgbm1 \
      libgcc1 \
      libglib2.0-0 \
      libgtk-3-0 \
      libnspr4 \
      libnss3 \
      libpango-1.0-0 \
      libpangocairo-1.0-0 \
      libstdc++6 \
      libx11-6 \
      libx11-xcb1 \
      libxcb1 \
      libxcb-dri3-0 \
      libxcb-glx0 \
      libxcb-present0 \
      libxcb-randr0 \
      libxcb-render0 \
      libxcb-shape0 \
      libxcb-shm0 \
      libxcb-sync1 \
      libxcb-xfixes0 \
      libxcomposite1 \
      libxcursor1 \
      libxdamage1 \
      libxext6 \
      libxfixes3 \
      libxi6 \
      libxinerama1 \
      libxkbcommon0 \
      libxkbcommon-x11-0 \
      libxrandr2 \
      libxrender1 \
      libxshmfence1 \
      libxss1 \
      libxtst6 \
      libxxf86vm1 \
      # Virtual framebuffer for headless rendering
      xvfb \
    ; \
    rm -rf /var/lib/apt/lists/*

# Add PostgreSQL PGDG repo and install PostgreSQL 16 (server + client)
RUN set -eux; \
    install -d -m 0755 /etc/apt/keyrings; \
    curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
      | gpg --dearmor -o /etc/apt/keyrings/postgresql.gpg; \
    echo "deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt bookworm-pgdg main" \
      > /etc/apt/sources.list.d/pgdg.list; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      postgresql-16 \
      postgresql-client-16 \
      libpq5 \
    ; \
    rm -rf /var/lib/apt/lists/*

# Install font tools and locales
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      fontconfig \
      locales \
    ; \
    rm -rf /var/lib/apt/lists/*

# Copy Verdana fonts (used by Playwright tests)
COPY Tests/Fonts/verdana /usr/share/fonts/truetype/verdana

# Rebuild font cache
RUN fc-cache -f -v

# Set working directory
WORKDIR /app/tests

# Install node modules in a shared location (/modules)
# This includes Playwright, Newman, and all dependencies
RUN mkdir -p /modules && \
    cd /modules && \
    npm init -y && \
    npm install \
      @playwright/test \
      newman \
      newman-reporter-htmlextra \
    && \
    npx playwright install chromium --with-deps && \
    rm -f package.json && \
    # Verify installations
    echo "Verifying installations..." && \
    ./node_modules/.bin/newman --version && \
    ./node_modules/.bin/playwright --version && \
    # Setup PATH in profile
    echo 'export PATH="/modules/node_modules/.bin:$PATH"' >> /etc/profile && \
    echo 'export NODE_PATH="/modules/node_modules:$NODE_PATH"' >> /etc/profile

# Set PATH and NODE_PATH environment variables
ENV PATH="/modules/node_modules/.bin:$PATH"
ENV NODE_PATH="/modules/node_modules:$NODE_PATH"

# Create directories for tests, results, startup scripts, and resources
# These will be populated via volume mounts at runtime
RUN mkdir -p \
    /app/tests \
    /app/tests/GUI \
    /app/tests/API \
    /app/tests/test-results \
    /app/startup \
    /app/resources

# Note: All application files (GUI tests, API tests, resources, startup scripts, entrypoint)
# should be mounted via -v volume mounts when running the container:
# Example:
#   docker run -v "$IMTCOREDIR/Tests/Docker/entrypoint.sh:/app/entrypoint.sh:ro" \
#              -v "$IMTCOREDIR/Tests/Docker/GUI:/app/tests/GUI:ro" \
#              -v "$(pwd)/Tests/GUI:/app/tests/GUI/app:ro" \
#              -v "$(pwd)/Tests/API:/app/tests/API:ro" \
#              -v "$(pwd)/Tests/Startup:/app/startup:ro" \
#              -v "$(pwd)/Tests/Resources:/app/resources:ro" \
#              -v "$(pwd)/Tests/test-results:/app/tests/test-results" \
#              imtcore-tests:linux

# Environment variables (can be overridden at runtime)
ENV BASE_URL=http://localhost:3000
ENV CI=true

# Default entrypoint (will be overridden to use mounted script)
ENTRYPOINT ["sh"]
CMD []