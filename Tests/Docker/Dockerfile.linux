# Dockerfile for ImtCore test environment
# This container provides the base infrastructure for running tests.
# Application-specific files (GUI tests, API tests, resources, startup scripts)
# should be copied from the application repository (e.g., Lisa) when running the container.

FROM node:18-bookworm

ENV DEBIAN_FRONTEND=noninteractive

# Install base dependencies and tools
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      wget \
      ca-certificates \
      curl \
      gnupg \
      lsb-release \
      xdg-utils \
      # GUI/Browser testing dependencies (for Playwright, Selenium, etc.)
      fonts-liberation \
      libappindicator3-1 \
      libasound2 \
      libatk-bridge2.0-0 \
      libatk1.0-0 \
      libc6 \
      libcairo2 \
      libcups2 \
      libdbus-1-3 \
      libexpat1 \
      libfontconfig1 \
      libgbm1 \
      libgcc1 \
      libglib2.0-0 \
      libgtk-3-0 \
      libnspr4 \
      libnss3 \
      libpango-1.0-0 \
      libpangocairo-1.0-0 \
      libstdc++6 \
      libx11-6 \
      libx11-xcb1 \
      libxcb1 \
      libxcomposite1 \
      libxcursor1 \
      libxdamage1 \
      libxext6 \
      libxfixes3 \
      libxi6 \
      libxrandr2 \
      libxrender1 \
      libxss1 \
      libxtst6 \
    ; \
    rm -rf /var/lib/apt/lists/*

# 2) Add PostgreSQL PGDG repo and install PostgreSQL 16 (server + client)
RUN set -eux; \
    install -d -m 0755 /etc/apt/keyrings; \
    curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
      | gpg --dearmor -o /etc/apt/keyrings/postgresql.gpg; \
    echo "deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt bookworm-pgdg main" \
      > /etc/apt/sources.list.d/pgdg.list; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      postgresql-16 \
      postgresql-client-16 \
      libpq5 \
    ; \
    rm -rf /var/lib/apt/lists/*

# Install font tools and locales
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      fontconfig \
      locales \
    ; \
    rm -rf /var/lib/apt/lists/*

# Copy Verdana fonts (used by Playwright tests)
COPY Tests/Fonts/verdana /usr/share/fonts/truetype/verdana

# Rebuild font cache
RUN fc-cache -f -v

# Set working directory
WORKDIR /app/tests

# Install Playwright and Newman (Postman CLI) globally
RUN npm install -g playwright newman && \
    npx playwright install --with-deps

# Create directories for tests, results, and custom apps
# The custom apps directories will be populated by copying from application repos (e.g., Lisa)
RUN mkdir -p \
    /app/tests \
    /app/tests/GUI \
    /app/tests/API \
    /app/tests/test-results/screenshots \
    /app/tests/test-results/videos \
    /app/custom-apps/startup \
    /app/custom-apps/resources

# Copy entrypoint script
COPY Tests/Docker/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Copy utils.js helper for Playwright tests
COPY Tests/Docker/utils.js /app/tests/utils.js

# Copy startup scripts and resources from ImtCore (if any exist)
# These are the base scripts that will be supplemented by application-specific scripts
COPY Tests/Docker/Startup/ /app/custom-apps/startup/
COPY Tests/Docker/Resources/ /app/custom-apps/resources/

# Environment variables (can be overridden at runtime)
ENV BASE_URL=http://localhost:3000
ENV CI=true
ENV START_POSTGRESQL=false
ENV POSTGRES_DB=""

ENTRYPOINT ["/app/entrypoint.sh"]
CMD [] 