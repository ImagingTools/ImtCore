version: '3.8'

# Docker Compose configuration for ImtCore test environment
# 
# This provides the base infrastructure for running tests.
# Application-specific tests, resources, and startup scripts should be copied
# from the application repository (e.g., Lisa) when running the container.
#
# Usage from application repository (e.g., Lisa):
# 1. Build this Docker image from ImtCore
# 2. Run container and copy your tests, resources, and startup scripts
# 3. Execute your test suite

services:
  # Base test environment
  tests:
    image: imtcore-tests:linux
    build:
      context: ../..
      dockerfile: Tests/Docker/Dockerfile.linux
    volumes:
      # Mount test results to host for review
      - ./test-results:/app/tests/test-results
    environment:
      # Application URL - should be set by the application repository
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      - CI=true
      
      # PostgreSQL settings
      - START_POSTGRESQL=${START_POSTGRESQL:-false}
      - POSTGRES_DB=${POSTGRES_DB:-}
      - DATABASE_URL=${DATABASE_URL:-}
      
      # Custom application environment variables
      # These should be set by the application repository
      - TEST_USERNAME=${TEST_USERNAME:-}
      - TEST_PASSWORD=${TEST_PASSWORD:-}
    network_mode: "host"
    # Alternative: use custom network if not using host mode
    # networks:
    #   - test-network

  # Example: Separate PostgreSQL service (alternative to START_POSTGRESQL)
  # Uncomment if you prefer a separate database container
  # postgres:
  #   image: postgres:15
  #   environment:
  #     - POSTGRES_PASSWORD=testpassword
  #     - POSTGRES_DB=test_db
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # If using separate services, update tests service:
  # tests:
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   network_mode: "bridge"  # Change from host
  #   environment:
  #     - DATABASE_URL=postgresql://postgres:testpassword@postgres:5432/test_db

# Uncomment if using custom network
# networks:
#   test-network:
#     driver: bridge

# Uncomment if using separate database service
# volumes:
#   postgres-data:
